leaders_batting_counting:
  description: "Top N leaders for a counting batting stat with ties (traded-safe)"
  patterns:
    - "(?i)(?:leaders?|top\\s*(?P<top_n>\\d+))\\s+in\\s+(?P<stat_label>hr|home runs?)\\s+(?:in|for)\\s+(?P<season>\\d{4})"
    - "(?i)who\\s+(?:leads?|are\\s+the\\s+leaders?).*\\b(?P<stat_label>hr|home\\s*runs?)\\b.*\\b(?P<season>\\d{4})"
    - "(?i)most\\s+(?P<stat_label>hr|home\\s*runs?)\\s+(?:in|for)\\s+(?P<season>\\d{4})"
  params: ["season", "top_n", "stat_col", "stat_label"]
  defaults: { top_n: 10, stat_col: "hr" }
  param_types: { season: int, top_n: int }
  sql: |
    WITH base AS (
      SELECT DISTINCT ON (fbl.idfg, fbl.season, TRIM(fbl.team))
             fbl.idfg,
             fbl.season,
             TRIM(fbl.team) AS team,
             fbl.name,
             {{ stat_col }} AS stat,
             fbl.pa,
             fbl.g
      FROM fangraphs_batting_lahman_like fbl
      WHERE season = %(season)s
      ORDER BY fbl.idfg, fbl.season, TRIM(fbl.team), fbl.pa DESC, fbl.g DESC, {{ stat_col }} DESC
    ),
    player AS (
      SELECT
        idfg,
        MAX(name) AS name,
        COALESCE(
          MAX(stat) FILTER (WHERE team = 'TOT'),
          SUM(stat) FILTER (WHERE team NOT IN ('TOT','---'))
        )::numeric AS "{{ stat_label }}"
      FROM base
      GROUP BY idfg
    )
    SELECT name, "{{ stat_label }}"
    FROM player
    ORDER BY "{{ stat_label }}" DESC, name ASC
    FETCH FIRST %(top_n)s ROWS WITH TIES;


leaders_pitching_counting:
  description: "Top N leaders for a counting pitching stat with ties (traded-safe)"
  params: ["season", "top_n", "stat_col", "stat_label"]
  defaults: { top_n: 10 }
  param_types: { season: int, top_n: int }
  sql: |
    WITH base AS (
      SELECT DISTINCT ON (fpl.idfg, fpl.season, TRIM(fpl.team))
             fpl.idfg,
             fpl.season,
             TRIM(fpl.team) AS team,
             fpl.name,
             {{ stat_col }} AS stat,
             fpl.ip,
             fpl.g
      FROM fangraphs_pitching_lahman_like fpl
      WHERE season = %(season)s
      ORDER BY fpl.idfg, fpl.season, TRIM(fpl.team), fpl.ip DESC, fpl.g DESC, {{ stat_col }} DESC
    ),
    pitcher AS (
      SELECT
        idfg,
        MAX(name) AS name,
        COALESCE(
          MAX(stat) FILTER (WHERE team = 'TOT'),
          SUM(stat) FILTER (WHERE team NOT IN ('TOT','---'))
        )::numeric AS "{{ stat_label }}"
      FROM base
      GROUP BY idfg
    )
    SELECT name, "{{ stat_label }}"
    FROM pitcher
    ORDER BY "{{ stat_label }}" DESC, name ASC
    FETCH FIRST %(top_n)s ROWS WITH TIES;


leaders_batting_rate:
  description: "Top N leaders for a batting rate stat with ties (weighted, traded-safe)"
  params: ["season", "top_n", "stat_col", "stat_label"]
  defaults: { top_n: 10 }
  param_types: { season: int, top_n: int }
  sql: |
    WITH base AS (
      SELECT DISTINCT ON (fbl.idfg, fbl.season, TRIM(fbl.team))
             fbl.idfg,
             fbl.season,
             TRIM(fbl.team) AS team,
             fbl.name,
             {{ stat_col }} AS stat,
             fbl.pa,
             fbl.g
      FROM fangraphs_batting_lahman_like fbl
      WHERE season = %(season)s
      ORDER BY fbl.idfg, fbl.season, TRIM(fbl.team), fbl.pa DESC, fbl.g DESC
    ),
    player AS (
      SELECT
        idfg,
        MAX(name) AS name,
        COALESCE(
          MAX(stat) FILTER (WHERE team = 'TOT'),
          SUM(stat * pa)::numeric / NULLIF(SUM(pa), 0)
        ) AS "{{ stat_label }}"
      FROM base
      GROUP BY idfg
    )
    SELECT name, "{{ stat_label }}"
    FROM player
    ORDER BY "{{ stat_label }}" DESC, name ASC
    FETCH FIRST %(top_n)s ROWS WITH TIES;


leaders_pitching_rate_low_is_best:
  description: "Top N leaders for a pitching rate stat (lower is better) with ties (weighted, traded-safe)"
  params: ["season", "top_n", "stat_col", "stat_label"]
  defaults: { top_n: 10, stat_col: "era" }
  param_types: { season: int, top_n: int }
  sql: |
    WITH base AS (
      SELECT DISTINCT ON (fpl.idfg, fpl.season, TRIM(fpl.team))
             fpl.idfg,
             fpl.season,
             TRIM(fpl.team) AS team,
             fpl.name,
             {{ stat_col }} AS stat,
             fpl.ip,
             fpl.g
      FROM fangraphs_pitching_lahman_like fpl
      WHERE season = %(season)s
      ORDER BY fpl.idfg, fpl.season, TRIM(fpl.team), fpl.ip DESC, fpl.g DESC
    ),
    pitcher AS (
      SELECT
        idfg,
        MAX(name) AS name,
        COALESCE(
          MAX(stat) FILTER (WHERE team = 'TOT'),
          SUM(stat * ip)::numeric / NULLIF(SUM(ip), 0)
        ) AS "{{ stat_label }}"
      FROM base
      GROUP BY idfg
    )
    SELECT name, "{{ stat_label }}"
    FROM pitcher
    ORDER BY "{{ stat_label }}" ASC, name ASC
    FETCH FIRST %(top_n)s ROWS WITH TIES;

leaders_batting_qualified:
  description: "Top N leaders with PA qualification (3.1 * max team games) with ties (traded-safe)"
  params: ["season", "top_n", "stat_agg", "stat_label"]
  defaults: { top_n: 10 }
  param_types: { season: int, top_n: int }
  sql: |
    WITH tg AS (
      SELECT MAX(g) AS max_games
      FROM fangraphs_batting_lahman_like
      WHERE season = %(season)s
    ),
    base AS (
      SELECT DISTINCT ON (fbl.idfg, fbl.season, TRIM(fbl.team))
             fbl.idfg,
             fbl.season,
             TRIM(fbl.team) AS team,
             fbl.name,
             fbl.pa,
             fbl.g
      FROM fangraphs_batting_lahman_like fbl
      WHERE season = %(season)s
      ORDER BY fbl.idfg, fbl.season, TRIM(fbl.team), fbl.pa DESC, fbl.g DESC
    ),
    player AS (
      SELECT
        idfg,
        MAX(name) AS name,
        COALESCE(
          MAX(pa) FILTER (WHERE team = 'TOT'),
          SUM(pa) FILTER (WHERE team NOT IN ('TOT','---'))
        ) AS pa_total,
        {{ stat_agg }} AS "{{ stat_label }}"
      FROM base
      GROUP BY idfg
    ),
    qualified AS (
      SELECT p.*
      FROM player p, tg
      WHERE p.pa_total >= (3.1 * tg.max_games)
    )
    SELECT name, "{{ stat_label }}"
    FROM qualified
    ORDER BY "{{ stat_label }}" DESC, name ASC
    FETCH FIRST %(top_n)s ROWS WITH TIES;
